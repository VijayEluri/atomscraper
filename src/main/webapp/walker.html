<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<script type="text/javascript">
var logOutput = "";
var startDate = new Date();
var start = startDate.getTime();
var outstandingAsynchCalls = 0;
var columns = new Array();
var values = new Array();


function load(uri) {
  try {
    log("start:" + start);
    loadXMLDoc("",columns, values, uri);
    log("end:" + sinceStart());
  } catch (e) { alert (e.description);}
}
function setDocumentContent() { 
	if (outstandingAsynchCalls == 0) {
		window.location.href='data:text/csv;charset=utf-8,' + 
      encodeURIComponent(columns.join(",") + "\n" + values.join(",") + "\n"); 
	// This also works, both methods require popup unblocking
  //  var win = window.open(
  //      'data:text/csv;charset=utf-8,' + 
  //       encodeURIComponent(columns.join(",") + "\n" + values.join(",") + "\n"),
  //    'jsTest'
  //   );
  } 
	
}

function loadXMLDoc(pathToNode, columns, values, url) {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange=function(){
    log("onreadystatechange:" + sinceStart());
    if (xhr.readyState==4) {
      if(xhr.status==200) {
        var xmlDoc = xhr.responseXML;
        if (xmlDoc == undefined) 
          throw new Error("xmlDoc null");
        if (xmlDoc.documentElement == undefined) {
          if (window.DOMParser)
          {
            throw new Error("xmlDoc.documentElement null");
          }
          else // Internet Explorer
          {
            xmlDoc=new ActiveXObject("Microsoft.XMLDOM");
            xmlDoc.async="false";
            xmlDoc.loadXML(xhr.responseText);
          }
          if (xmlDoc.documentElement == undefined) {
            throw new Error("xmlDoc.documentElement still null");
          }
        }
        if (xmlDoc.documentElement.nodeName == undefined) 
          throw new Error("xmlDoc.documentElement.nodeName null");
        if (pathToNode != "")
          pathToNode = pathToNode + ".";
        if (pathToNode != "")
          pathToNode = pathToNode + ".";
        pathToNode = pathToNode + xmlDoc.documentElement.nodeName + "/1";   
        flatten(pathToNode, columns, values, xmlDoc.documentElement);

        log("done:" + sinceStart());
      } else {
    	  if(xhr.status==0)
    	    throw new Error("Unexpected http status: " +  xhr.status + "; are you authorised?");
    	  else
    	    throw new Error("Unexpected http status: " +  xhr.status);
      }
      outstandingAsynchCalls--;  
      setDocumentContent();
    }
  };

  
  outstandingAsynchCalls++;
  log("open:" + sinceStart());
  xhr.open("GET", url, true); 
  log("opened:" + sinceStart());
  xhr.send();
  log("sent:" + sinceStart());
  
}

function flatten(pathToValue, columns, values, element) { 
  log("dump\n" + dump(element));
  log("flatten in :" + sinceStart());
		var kids = element.childNodes;
		if (kids.length == 1) {
			// element is a leaf
			// If there are no Child Elements then 
			// the first child will be a text one
			var textContent = element.childNodes[0];
			if (textContent== undefined){
			  throw new Error("Node zero undefined ");
   } else {
  			if (trim(textContent.nodeValue) != "") { 
  	      columns[columns.length] = pathToValue;
          values[values.length] = textContent.nodeValue;
        } 
  	  }
		}
		else {
			// element is not a leaf, recurse
			var counts = {};
			
      for (var i = 0; i < kids.length; i++){
			  var kid = kids[i];
			 	var name = kid.nodeName;

			  if (name == "#text" && kid.nodeValue) { 
			    if(trim(kid.nodeValue) != "" ) 
			      throw new Error("found text when kids length =  " + kids.length);
  			} else if (name == undefined) {
  			  throw new Error("undefined at " + i + " when kids length =  " + kids.length);
  			} else	if (name == "atom:link") {
  			  if (kid.getAttribute("rel") == "http://www.cggh.org/2010/chassis/terms/studyInfo") { 
    			  var linkUrl = kid.getAttribute("href");
  			    loadXMLDoc(pathToValue + ".", columns, values, linkUrl)
  			  }
  			} else {
  			 	if (counts[name])
		  	 	 	counts[name] = counts[name]+1;
			   	else 
			   	  counts[name] = 1;
				
			   	var newContext = pathToValue + "." + name + "/" + counts[name];
			   	flatten(newContext, columns, values, kid);
	
		  	}
		 }
     log("flatten out :"+ sinceStart());
		}

}
function log(text){ 
  message("Log", text);
}
function message(type, text) { 
    logOutput = logOutput + "<br/>\n" + type + ":" + text;      	
}
function dump(node) {
  var returnString = node.nodeName + "(" + node.nodeType+")=" + node.nodeValue + "\n";
  var kids = node.childNodes;
  returnString = returnString + "length:"  + kids.length +"\n";
  for (var i = 0; i < kids.length; i++){
    returnString = returnString + "--" +  i + ")" + kids[i].nodeName + "(" + kids[i].nodeType + ")=" + kids[i].nodeValue + "\n";
  }
  return returnString; 
}
function trim (str) {
  if (str==null) return "";
  var  str = str.replace(/^\s\s*/, ''),
       ws = /\s/,
       i = str.length;
  while (ws.test(str.charAt(--i)));
  return str.slice(0, i + 1);
}
function isDataUriSchemeSupported() { 
  if(/msie/i.test(navigator.userAgent) ) 
    return false; // IE does nto allow navigation to data urls
  var data = new Image();
  var is = true;
  data.onload = data.onerror = function(){
    if(this.width != 1 || this.height != 1)
      is = false;
  }
  data.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
  return is;  
}
function sinceStart() {
  var nowDate = new Date();
  return  nowDate.getTime() - start; 
}

function submitted() { 
  load(document.flattenerForm.uri.value);
  //document.getElementById("console").innerHTML = logOutput;
	 return false;
}
function loaded() { // Exclude MS, ok for Firefox, Chrome, Opera, Safari
  if (window.XMLHttpRequest && isDataUriSchemeSupported()) {
    document.getElementById("DataUriSchemeSupported").style.visibility = "visible";
  } else // MS Browsers 
    document.getElementById("DataUriSchemeNotSupported").style.visibility = "visible";
}
</script>
</head>
<body onload="loaded();">
<div id="flattener">
<pre id="content" />
<div id="DataUriSchemeSupported" style="visibility:hidden;">
<form onSubmit="submitted();" id="flattenerForm" name="flattenerForm" >
<!--  
   value="https://www.wwarn.org/repository/atombeat/content/studies/JGZGH.atom"
   value="https://balbo.well.ox.ac.uk/repository/atombeat/content/studies/JGZGH.atom"
   value="http://localhost:8080/atomscraper/testdata/studies/KHDXJ.xml" 
 -->   
 <input type="text" name="uri" id="uri" size="60"
   value="http://balbo.well.ox.ac.uk/timp/test.xml"
 />
 <input type="button" value="Flatten" onClick="submitted();" id="flatten" name="flatten" />
</form>
</div>
<div id="DataUriSchemeNotSupported" style="visibility:hidden;">
Additional functionality not available in this browser.
</div>
<pre id="console" />
</div>


</html>