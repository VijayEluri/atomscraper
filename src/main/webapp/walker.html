<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<script type="text/javascript">
var logOutput = "";
var startDate = new Date();
var start = startDate.getTime();
var outstandingAsynchCalls = 0;
var columns = new Array();
var values = new Array();

function sinceStart() {
  var nowDate = new Date();
  return  nowDate.getTime() - start; 
}

function load(uri) {
  log("start:" + start);
  loadXMLDoc("",columns, values, uri);
  log("end:" + sinceStart());
}
function setDocumentContent() { 
	if (outstandingAsynchCalls == 0) {
		window.location.href='data:text/csv;charset=utf-8;filename=t.csv;Content-Disposition=atom.csv,' + 
      encodeURIComponent(columns.join(",") + "\n" + values.join(",") + "\n"); 
	// This also works, both methods require popup unblocking
  //  var win = window.open(
  //      'data:text/csv;charset=utf-8,' + 
  //       encodeURIComponent(columns.join(",") + "\n" + values.join(",") + "\n"),
  //    'jsTest'
  //   );
  } 
	
}

function loadXMLDoc(pathToNode, columns, values, url) {
  var xhr;
  if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
    xhr = new XMLHttpRequest();
  }
  else {// code for IE6, IE5
    xhr = new ActiveXObject("Microsoft.XMLHTTP");
  }
  xhr.onreadystatechange=function(){
    log("onreadystatechange:" + sinceStart());
    if (xhr.readyState==4) {
      if(xhr.status==200) {
        var xmlDoc = xhr.responseXML;
        if (xmlDoc == undefined) 
          RuntimeException("xmlDoc null");
        if (pathToNode != "")
          pathToNode = pathToNode + ".";
        pathToNode = pathToNode + xmlDoc.documentElement.nodeName + "/1";   
        flatten(pathToNode, columns, values, xmlDoc.documentElement);

        log("done:" + sinceStart());
      } else {
    	  if(xhr.status==0)
          RuntimeException("Unexpected http status: " +  xhr.status + "; are you authorised?");
    	  else
    	    RuntimeException("Unexpected http status: " +  xhr.status);
      }
      outstandingAsynchCalls--;  
      setDocumentContent();
    }
  };

  
  outstandingAsynchCalls++;
  log("open:" + sinceStart());
  xhr.open("GET", url, true); 
  log("opened:" + sinceStart());
  xhr.send();
  log("sent:" + sinceStart());
  
}

function flatten(pathToValue, columns, values, element) { 
  log("dump\n" + dump(element));
  log("flatten in :" + sinceStart());
		var kids = element.childNodes;
		if (kids.length == 1) {
			// element is a leaf
			// If there are no Child Elements then 
			// the first child will be a text one
			var textContent = element.childNodes[0];
			if (textContent== undefined){
			  RuntimeException("Node zero undefined ");
   } else {
  			if (trim(textContent.nodeValue) != "") { 
  	      columns[columns.length] = pathToValue;
          values[values.length] = textContent.nodeValue;
        } 
  	  }
		}
		else {
			// element is not a leaf, recurse
			var counts = {};
			
      for (var i = 0; i < kids.length; i++){
			  var kid = kids[i];
			 	var name = kid.nodeName;

			  if (name == "#text" && kid.nodeValue) { 
			    if(trim(kid.nodeValue) != "" ) 
  			  RuntimeException("found text when kids length =  " + kids.length);
  			} else if (name == undefined) {
  			  RuntimeException("undefined at " + i + " when kids length =  " + kids.length);
  			} else	if (name == "atom:link") {
  			  if (kid.getAttribute("rel") == "http://www.cggh.org/2010/chassis/terms/studyInfo") { 
    			  var linkUrl = kid.getAttribute("href");
  			    loadXMLDoc(pathToValue + ".", columns, values, linkUrl)
  			  }
  			} else {
  			 	if (counts[name])
		  	 	 	counts[name] = counts[name]+1;
			   	else 
			   	  counts[name] = 1;
				
			   	var newContext = pathToValue + "." + name + "/" + counts[name];
			   	flatten(newContext, columns, values, kid);
	
		  	}
		 }
     log("flatten out :"+ sinceStart());
		}

}
function log(text){ 
  message("Log", text);
}
function RuntimeException(text) { 
  message("Err", text);
  document.getElementById("console").innerHTML = logOutput;
}
function message(type, text) { 
    logOutput = logOutput + "<br/>\n" + type + ":" + text;      	
}
function dump(node) {
  var returnString = node.nodeName + "(" + node.nodeType+")=" + node.nodeValue + "\n";
  var kids = node.childNodes;
  returnString = returnString + "length:"  + kids.length +"\n";
  for (var i = 0; i < kids.length; i++){
    returnString = returnString + "--" +  i + ")" + kids[i].nodeName + "(" + kids[i].nodeType + ")=" + kids[i].nodeValue + "\n";
  }
  return returnString; 
}
function trim (str) {
  var  str = str.replace(/^\s\s*/, ''),
       ws = /\s/,
       i = str.length;
  while (ws.test(str.charAt(--i)));
  return str.slice(0, i + 1);
}

function submitted() { 
  load(document.flattenerForm.uri.value);
  //document.getElementById("console").innerHTML = logOutput;
	return false;
}
</script>
</head>
<body>
<pre id="content" />
<form onSubmit="return false;" id="flattenerForm" name="flattenerForm" method="POST">
<!--  
   value="https://www.wwarn.org/repository/atombeat/content/studies/JGZGH.atom"
    value="http://localhost:8080/atomscraper/testdata/studies/KHDXJ.xml" />
 -->   
 <input type="text" name="uri" id="uri" size="60"
   value="https://balbo.well.ox.ac.uk/repository/atombeat/content/studies/JGZGH.atom"
 />
 <input type="submit" value="Flatten" onClick="submitted();" />
</form>
<pre id="console" />



</html>